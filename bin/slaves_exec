#!/bin/bash

source common_functions

require_master

FORK=NO
SELF=NO

for i in "$@"
do
  case $i in
    -p)
      FORK=YES
      shift
      ;;
    -m)
      SELF=YES
      shift
      ;;
    *)
      break
      ;;
  esac
done

for host in $SLAVE_NAMES
do
  echo "========== $host =========="
  if [ "$FORK" == "YES" ]
  then
    ( ssh $host.local "$*" | sed "s/^/$host: /g" ) &
  else
    ssh $host.local "$*"
  fi
done

if [ "$SELF" == "YES" ]
then
  echo "========== $MASTER_NAME =========="
  if [ "$FORK" == "YES" ]
  then
    ( $* | sed "s/^/$host: /g" ) &
  else
    $*
  fi
fi

if [ "$FORK" == "YES" ]
then
  for job in `jobs -p`
  do
    wait $job
  done
  echo ========== DONE ==========
fi
