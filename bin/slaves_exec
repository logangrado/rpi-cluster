#!/bin/bash

source common_functions
require_master

FORK=NO
SELF=NO

for i in "$@"
do
  case $i in
    -p)
      FORK=YES
      shift
      ;;
    -m)
      SELF=YES
      shift
      ;;
    *)
      break
      ;;
  esac
done

declare -a colorval=(31 32 33 34 35 36 37 38)

for host in $SLAVE_NAMES
do
  echo "========== $host =========="
  if [ "$FORK" == "YES" ]
  then
    color=${colorval[$index]}
    index=$[index+1]
    ( ssh $host.local "$*" | sed "s/^/\x1B[${color}m$host:\x1B[39m /g" ) &
  else
    ssh $host.local "$*"
  fi
done

if [ "$SELF" == "YES" ]
then
  echo "========== $MASTER_NAME =========="
  if [ "$FORK" == "YES" ]
  then
    ( $* | sed "s/^/$MASTER_NAME: /g" ) &
  else
    $*
  fi
fi

if [ "$FORK" == "YES" ]
then
  for job in `jobs -p`
  do
    wait $job
  done
  echo ========== DONE ==========
fi
